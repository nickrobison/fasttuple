name: Test Release Configuration
on:
  pull_request:
    paths:
      - 'build.gradle.kts'
      - 'fasttuple-core/build.gradle.kts'
      - 'jreleaser.yml'
      - '.github/workflows/deploy.yaml'
      - '.github/workflows/test-release.yaml'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no actual deployment)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: zulu
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      
      - name: Version
        id: version
        run: |
          VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Project version: ${VERSION}"
      
      - name: Build and publish to staging repository
        run: ./gradlew publish -Pversion=${{ steps.version.outputs.VERSION }}
      
      - name: Verify staging artifacts
        run: |
          echo "Checking for staged artifacts..."
          STAGING_DIR="fasttuple-core/build/staging-deploy"
          if [ -d "$STAGING_DIR" ]; then
            echo "✓ Staging directory exists"
            find "$STAGING_DIR" -type f -name "*.jar" -o -name "*.pom" | while read file; do
              echo "  Found: $file"
            done
            
            # Check for required artifacts
            if find "$STAGING_DIR" -name "fasttuple-core-*.jar" | grep -q .; then
              echo "✓ Main JAR found"
            else
              echo "✗ Main JAR not found"
              exit 1
            fi
            
            if find "$STAGING_DIR" -name "fasttuple-core-*-sources.jar" | grep -q .; then
              echo "✓ Sources JAR found"
            else
              echo "✗ Sources JAR not found"
              exit 1
            fi
            
            if find "$STAGING_DIR" -name "fasttuple-core-*-javadoc.jar" | grep -q .; then
              echo "✓ Javadoc JAR found"
            else
              echo "✗ Javadoc JAR not found"
              exit 1
            fi
            
            if find "$STAGING_DIR" -name "*.pom" | grep -q .; then
              echo "✓ POM file found"
            else
              echo "✗ POM file not found"
              exit 1
            fi
          else
            echo "✗ Staging directory not found"
            exit 1
          fi
      
      - name: Validate POM content
        run: |
          echo "Validating POM content..."
          POM_FILE=$(find fasttuple-core/build/staging-deploy -name "*.pom" | head -1)
          if [ -f "$POM_FILE" ]; then
            echo "Checking POM: $POM_FILE"
            
            # Check for required POM elements
            if grep -q "<name>fasttuple-core</name>" "$POM_FILE"; then
              echo "✓ Project name found"
            else
              echo "✗ Project name not found"
              exit 1
            fi
            
            if grep -q "<description>" "$POM_FILE"; then
              echo "✓ Description found"
            else
              echo "✗ Description not found"
              exit 1
            fi
            
            if grep -q "<url>https://github.com/nickrobison/fasttuple</url>" "$POM_FILE"; then
              echo "✓ Project URL found"
            else
              echo "✗ Project URL not found"
              exit 1
            fi
            
            if grep -q "<license>" "$POM_FILE"; then
              echo "✓ License information found"
            else
              echo "✗ License information not found"
              exit 1
            fi
            
            if grep -q "<developer>" "$POM_FILE"; then
              echo "✓ Developer information found"
            else
              echo "✗ Developer information not found"
              exit 1
            fi
            
            if grep -q "<scm>" "$POM_FILE"; then
              echo "✓ SCM information found"
            else
              echo "✗ SCM information not found"
              exit 1
            fi
            
            echo ""
            echo "POM validation successful!"
          else
            echo "✗ POM file not found"
            exit 1
          fi
      
      - name: Test JReleaser configuration (dry-run)
        env:
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JRELEASER_GPG_PASSPHRASE: "test-passphrase"
          JRELEASER_GPG_PUBLIC_KEY: "test-public-key"
          JRELEASER_GPG_SECRET_KEY: "test-secret-key"
          JRELEASER_MAVENCENTRAL_USERNAME: "test-username"
          JRELEASER_MAVENCENTRAL_PASSWORD: "test-password"
        run: |
          echo "Testing JReleaser configuration..."
          ./gradlew jreleaserConfig --stacktrace
          
          echo ""
          echo "JReleaser configuration generated successfully!"
      
      - name: Display JReleaser configuration
        run: |
          if [ -f "fasttuple-core/build/jreleaser/output.properties" ]; then
            echo "JReleaser output properties:"
            cat fasttuple-core/build/jreleaser/output.properties
          fi
          
          if [ -f "fasttuple-core/build/jreleaser/trace.log" ]; then
            echo ""
            echo "JReleaser trace log (last 50 lines):"
            tail -50 fasttuple-core/build/jreleaser/trace.log
          fi
      
      - name: Upload staging artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: staging-artifacts
          path: fasttuple-core/build/staging-deploy/
          retention-days: 7
      
      - name: Upload JReleaser logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jreleaser-logs
          path: |
            fasttuple-core/build/jreleaser/
            out/jreleaser/
          retention-days: 7
      
      - name: Summary
        if: success()
        run: |
          echo "## ✅ Release Configuration Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks completed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Artifacts built and staged" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ POM validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ JReleaser configuration valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
