name: Maven Deploy
on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no actual deployment)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  workflow_run:
    workflows:
      - 'Build and test'
    types:
      - completed
    branches:
      - master

permissions:
  contents: write  # Required for creating releases and tags
  actions: read    # Required for workflow_run trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: zulu
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      
      - name: Version
        id: version
        run: |
          VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Project version: ${VERSION}"
      
      - name: Build and publish to staging repository
        run: ./gradlew publish -Pversion=${{ steps.version.outputs.VERSION }}
      
      - name: Run JReleaser
        env:
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_SECRET_KEY }}
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: |
          if [ "${{ github.event.inputs.dry-run }}" == "true" ]; then
            echo "Running in dry-run mode..."
            ./gradlew jreleaserFullRelease -Pjreleaser.dry.run=true
          else
            echo "Running full release..."
            ./gradlew jreleaserFullRelease
          fi
      
      - name: Upload JReleaser logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jreleaser-logs
          path: |
            fasttuple-core/build/jreleaser/
            out/jreleaser/
          retention-days: 30

